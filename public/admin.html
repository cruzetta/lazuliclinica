<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Clínica Lazuli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: #f7fafc;
        }
        .admin-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #B8860B;
            color: white;
        }
        .btn-primary:hover {
            background-color: #A0740A;
        }
        .btn-danger {
            background-color: #e53e3e;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c53030;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #B8860B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .auth-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body>

    <!-- TELA DE LOGIN -->
    <div id="auth-container" class="auth-container">
        <h1 class="text-2xl font-bold text-center mb-2">Clínica Lazuli</h1>
        <h2 class="text-xl text-center font-semibold mb-6">Painel Administrativo</h2>
        <div id="login-form">
            <input type="email" id="email" placeholder="Seu email" class="input-field mb-4">
            <input type="password" id="password" placeholder="Sua senha" class="input-field mb-4">
            <button id="login-button" class="btn btn-primary w-full">Entrar</button>
            <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL DO PAINEL -->
    <div id="admin-panel" class="hidden container mx-auto p-6">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Painel de Conteúdo</h1>
            <button id="logout-button" class="btn btn-danger">Sair</button>
        </div>

        <div id="loading" class="loader"></div>
        <div id="content-sections" class="hidden">
            <!-- Seção "Página Inicial (Entrada)" -->
            <div class="admin-card">
                <h3 class="text-2xl font-semibold mb-4">Página Inicial (Entrada)</h3>
                <div id="home-section-admin">
                    <label for="home-headline" class="font-semibold">Título Principal:</label>
                    <input type="text" id="home-headline" placeholder="Ex: Beleza em equilíbrio, sorriso em harmonia." class="input-field mb-4">

                    <label for="home-subheadline" class="font-semibold">Subtítulo:</label>
                    <textarea id="home-subheadline" placeholder="Ex: Na Lazúli, unimos ciência e estética..." class="input-field mb-4 h-24"></textarea>

                    <label for="home-bg-video-url" class="font-semibold">URL do Vídeo de Fundo (.mp4):</label>
                    <input type="text" id="home-bg-video-url" placeholder="Cole a URL completa do vídeo .mp4 aqui" class="input-field">
                    
                    <button id="save-home" class="btn btn-primary mt-4">Salvar Alterações da Página Inicial</button>
                </div>
            </div>

            <!-- Seção "Sobre" -->
            <div class="admin-card">
                <h3 class="text-2xl font-semibold mb-4">Seção "Sobre"</h3>
                <div id="about-section">
                    <label class="font-semibold">Foto do Dr. Ítalo Rottoli:</label>
                    <img id="about-image-preview" src="https://placehold.co/400x400?text=Sem+Imagem" alt="Preview da imagem sobre" class="my-4 rounded-lg max-w-xs">
                    <input type="text" id="about-image-url" placeholder="Cole a URL completa da imagem aqui" class="input-field">
                    <button id="save-about" class="btn btn-primary mt-4">Salvar Alterações</button>
                </div>
            </div>

            <!-- NOVA Seção "Tratamentos" -->
            <div class="admin-card">
                <h3 class="text-2xl font-semibold mb-4">Seção "Tratamentos"</h3>
                <p class="text-sm text-gray-600 mb-6">Gerencie os ícones, títulos e textos da seção de tratamentos.</p>
                
                <div id="treatments-section-admin" class="space-y-8">
                    <!-- Gerenciador para Harmonização Facial -->
                    <div class="border-t pt-6 space-y-4">
                        <h4 class="text-xl font-semibold">Card 1: Harmonização Facial</h4>
                        <div>
                            <label for="harmonizacao-icon-url" class="font-semibold">URL do Ícone/Imagem (com prévia):</label>
                            <div class="flex items-center gap-4 mt-2">
                                <input type="text" id="harmonizacao-icon-url" placeholder="Cole a URL da imagem aqui para ver a prévia" class="input-field flex-grow">
                                <div class="w-20 h-20 bg-lazuli-nude rounded-full flex items-center justify-center overflow-hidden shadow-inner flex-shrink-0">
                                    <img id="harmonizacao-icon-preview" src="https://placehold.co/80x80?text=Prévia" alt="Preview" class="w-full h-full object-cover">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="harmonizacao-title" class="font-semibold">Título:</label>
                            <input type="text" id="harmonizacao-title" class="input-field">
                        </div>
                        <div>
                            <label for="harmonizacao-description" class="font-semibold">Descrição:</label>
                            <textarea id="harmonizacao-description" class="input-field h-24"></textarea>
                        </div>
                         <div>
                            <label for="harmonizacao-features" class="font-semibold">Itens da Lista (um por linha):</label>
                            <textarea id="harmonizacao-features" class="input-field h-24"></textarea>
                        </div>
                    </div>
            
                    <!-- Gerenciador para Lentes de Contato -->
                    <div class="border-t pt-6 space-y-4">
                        <h4 class="text-xl font-semibold">Card 2: Lentes de Contato Dental</h4>
                        <div>
                            <label for="lentes-icon-url" class="font-semibold">URL do Ícone/Imagem (com prévia):</label>
                            <div class="flex items-center gap-4 mt-2">
                                <input type="text" id="lentes-icon-url" placeholder="Cole a URL da imagem aqui para ver a prévia" class="input-field flex-grow">
                                <div class="w-20 h-20 bg-lazuli-nude rounded-full flex items-center justify-center overflow-hidden shadow-inner flex-shrink-0">
                                    <img id="lentes-icon-preview" src="https://placehold.co/80x80?text=Prévia" alt="Preview" class="w-full h-full object-cover">
                                </div>
                            </div>
                        </div>
                         <div>
                            <label for="lentes-title" class="font-semibold">Título:</label>
                            <input type="text" id="lentes-title" class="input-field">
                        </div>
                        <div>
                            <label for="lentes-description" class="font-semibold">Descrição:</label>
                            <textarea id="lentes-description" class="input-field h-24"></textarea>
                        </div>
                         <div>
                            <label for="lentes-features" class="font-semibold">Itens da Lista (um por linha):</label>
                            <textarea id="lentes-features" class="input-field h-24"></textarea>
                        </div>
                    </div>
                    
                    <button id="save-treatments" class="btn btn-primary mt-6 w-full">Salvar Alterações dos Tratamentos</button>
                </div>
            </div>

            <!-- Seção "Galeria de Resultados" -->
            <div class="admin-card">
                <h3 class="text-2xl font-semibold mb-4">Galeria "Transformações Reais"</h3>
                <div id="gallery-section" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- As imagens da galeria serão carregadas aqui -->
                </div>
                <div class="mt-6">
                    <h4 class="text-xl font-semibold">Adicionar Nova Imagem</h4>
                    <input type="text" id="gallery-image-url" placeholder="Cole a URL da nova imagem aqui" class="input-field mt-2">
                    <button id="add-gallery-image" class="btn btn-primary mt-4">Adicionar à Galeria</button>
                </div>
            </div>
            
            <!-- Seção "Fundos de Seção" -->
            <div class="admin-card">
                <h3 class="text-2xl font-semibold mb-4">Imagens de Fundo das Seções</h3>
                <p class="text-sm text-gray-600 mb-6">Cole a URL completa da imagem para cada seção. Deixe o campo em branco para usar a cor padrão do site.</p>
                <div id="backgrounds-section" class="space-y-6">
                    <!-- Os campos para as imagens de fundo serão carregados aqui pelo JavaScript -->
                </div>
            </div>

             <!-- Seção "Depoimentos" -->
            <div class="admin-card">
                <h3 class="text-2xl font-semibold mb-4">Seção "Depoimentos"</h3>
                <div id="testimonials-section" class="space-y-4">
                    <!-- Os depoimentos serão carregados aqui -->
                </div>
                <div class="mt-6">
                    <h4 class="text-xl font-semibold">Adicionar Novo Depoimento</h4>
                    <input type="text" id="testimonial-name" placeholder="Nome (Ex: Mariana S.)" class="input-field">
                    <textarea id="testimonial-text" placeholder="Texto do depoimento" class="input-field mt-2"></textarea>
                    <button id="add-testimonial" class="btn btn-primary mt-4">Adicionar Depoimento</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Elementos da UI
        const authContainer = document.getElementById('auth-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const loading = document.getElementById('loading');
        const contentSections = document.getElementById('content-sections');

        // --- LÓGICA DE AUTENTICAÇÃO ---
        auth.onAuthStateChanged(user => {
            if (user) {
                authContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadContent();
            } else {
                authContainer.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                loading.classList.add('hidden');
                contentSections.classList.add('hidden');
            }
        });

        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    authError.textContent = 'Email ou senha inválidos.';
                    console.error("Erro de login:", error);
                });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // --- FUNÇÕES DE CARREGAMENTO DE CONTEÚDO ---
        async function loadContent() {
            loading.classList.remove('hidden');
            contentSections.classList.add('hidden');
            try {
                await loadHomeSection();
                await loadAboutSection();
                await loadTreatmentsSection(); // Carrega a nova seção
                await loadGallerySection();
                await loadTestimonialsSection();
                await loadBackgroundsSection();
            } catch (error) {
                console.error("Erro ao carregar conteúdo:", error);
                alert("Não foi possível carregar o conteúdo do site.");
            } finally {
                loading.classList.add('hidden');
                contentSections.classList.remove('hidden');
            }
        }
        
        async function loadHomeSection() {
            const docRef = db.collection("siteContent").doc("home");
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                document.getElementById('home-headline').value = data.headline || '';
                document.getElementById('home-subheadline').value = data.subheadline || '';
                document.getElementById('home-bg-video-url').value = data.backgroundVideoUrl || '';
            }
        }

        async function loadAboutSection() {
            const docRef = db.collection("siteContent").doc("sobre");
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                document.getElementById('about-image-preview').src = data.imageUrl || 'https://placehold.co/400x400?text=Sem+Imagem';
                document.getElementById('about-image-url').value = data.imageUrl || '';
            }
        }

        // NOVA FUNÇÃO para carregar dados dos tratamentos
        async function loadTreatmentsSection() {
            const docRef = db.collection("siteContent").doc("treatments");
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                if (data.harmonizacao) {
                    const hData = data.harmonizacao;
                    document.getElementById('harmonizacao-icon-url').value = hData.iconUrl || '';
                    document.getElementById('harmonizacao-icon-preview').src = hData.iconUrl || 'https://placehold.co/80x80?text=Prévia';
                    document.getElementById('harmonizacao-title').value = hData.title || '';
                    document.getElementById('harmonizacao-description').value = hData.description || '';
                    document.getElementById('harmonizacao-features').value = (hData.features || []).join('\n');
                }
                if (data.lentes) {
                    const lData = data.lentes;
                    document.getElementById('lentes-icon-url').value = lData.iconUrl || '';
                    document.getElementById('lentes-icon-preview').src = lData.iconUrl || 'https://placehold.co/80x80?text=Prévia';
                    document.getElementById('lentes-title').value = lData.title || '';
                    document.getElementById('lentes-description').value = lData.description || '';
                    document.getElementById('lentes-features').value = (lData.features || []).join('\n');
                }
            }
        }

        async function loadGallerySection() {
            const galleryContainer = document.getElementById('gallery-section');
            galleryContainer.innerHTML = '';
            const querySnapshot = await db.collection("gallery").get();
            if(querySnapshot.empty) {
                galleryContainer.innerHTML = '<p class="col-span-full">Nenhuma imagem na galeria ainda.</p>';
            } else {
                querySnapshot.forEach((doc) => {
                    const imageData = doc.data();
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative group';
                    imageDiv.innerHTML = `
                        <img src="${imageData.url}" class="w-full h-32 object-cover rounded-md">
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button data-id="${doc.id}" class="btn btn-danger btn-sm delete-gallery-item">Excluir</button>
                        </div>
                    `;
                    galleryContainer.appendChild(imageDiv);
                });
            }
        }

        async function loadTestimonialsSection() {
            const testimonialsContainer = document.getElementById('testimonials-section');
            testimonialsContainer.innerHTML = '';
            const querySnapshot = await db.collection("testimonials").get();
             if(querySnapshot.empty) {
                testimonialsContainer.innerHTML = '<p>Nenhum depoimento adicionado.</p>';
            } else {
                querySnapshot.forEach((doc) => {
                    const testimonialData = doc.data();
                    const testimonialDiv = document.createElement('div');
                    testimonialDiv.className = 'p-4 border rounded-lg flex justify-between items-start';
                    testimonialDiv.innerHTML = `
                        <div>
                            <p class="font-bold">${testimonialData.name}</p>
                            <p class="italic">"${testimonialData.text}"</p>
                        </div>
                        <button data-id="${doc.id}" class="btn btn-danger btn-sm mt-2 delete-testimonial-item">Excluir</button>
                    `;
                    testimonialsContainer.appendChild(testimonialDiv);
                });
            }
        }
        
        async function loadBackgroundsSection() {
            const container = document.getElementById('backgrounds-section');
            container.innerHTML = ''; 
            const sections = [ { id: 'sobre', name: 'Sobre' }, { id: 'filosofia', name: 'Filosofia' }, { id: 'tratamentos', name: 'Tratamentos' }, { id: 'galeria', name: 'Resultados (Galeria)' }, { id: 'faq', name: 'Dúvidas Frequentes' }, { id: 'depoimentos', name: 'Depoimentos' }, { id: 'agendamento', name: 'Agendamento' }];
            const docRef = db.collection("siteContent").doc("backgrounds");
            const docSnap = await docRef.get();
            const data = docSnap.exists ? docSnap.data() : {};
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `
                    <label for="bg-url-${section.id}" class="font-semibold text-lg">Seção "${section.name}"</label>
                    <div class="flex items-center gap-4 mt-2">
                        <input type="text" id="bg-url-${section.id}" placeholder="Cole a URL da imagem aqui" class="input-field flex-grow" value="${data[section.id] || ''}">
                        <button data-section-id="${section.id}" class="btn btn-primary save-background-btn">Salvar</button>
                    </div>
                `;
                container.appendChild(sectionDiv);
            });
        }

        // --- FUNÇÕES DE SALVAMENTO ---
        document.getElementById('save-home').addEventListener('click', async () => {
            const headline = document.getElementById('home-headline').value.trim();
            const subheadline = document.getElementById('home-subheadline').value.trim();
            const backgroundVideoUrl = document.getElementById('home-bg-video-url').value.trim();
            if (!headline || !subheadline) { alert("Por favor, preencha o título e o subtítulo."); return; }
            try {
                await db.collection("siteContent").doc("home").set({ headline, subheadline, backgroundVideoUrl }, { merge: true });
                alert("Página Inicial atualizada com sucesso!");
            } catch (error) { console.error("Erro ao salvar a Página Inicial:", error); alert("Ocorreu um erro. Tente novamente."); }
        });

        document.getElementById('save-about').addEventListener('click', async () => {
            const imageUrl = document.getElementById('about-image-url').value.trim();
            if (!imageUrl) { alert("Por favor, cole a URL da imagem."); return; }
            try {
                await db.collection("siteContent").doc("sobre").set({ imageUrl });
                alert("Seção 'Sobre' atualizada com sucesso!");
                loadAboutSection();
            } catch (error) { console.error("Erro ao salvar seção sobre:", error); alert("Ocorreu um erro. Tente novamente."); }
        });

        // NOVA FUNÇÃO para salvar os tratamentos
        document.getElementById('save-treatments').addEventListener('click', async () => {
            const newData = {
                harmonizacao: {
                    iconUrl: document.getElementById('harmonizacao-icon-url').value.trim(),
                    title: document.getElementById('harmonizacao-title').value.trim(),
                    description: document.getElementById('harmonizacao-description').value.trim(),
                    features: document.getElementById('harmonizacao-features').value.split('\n').map(s => s.trim()).filter(Boolean)
                },
                lentes: {
                    iconUrl: document.getElementById('lentes-icon-url').value.trim(),
                    title: document.getElementById('lentes-title').value.trim(),
                    description: document.getElementById('lentes-description').value.trim(),
                    features: document.getElementById('lentes-features').value.split('\n').map(s => s.trim()).filter(Boolean)
                }
            };
            try {
                await db.collection("siteContent").doc("treatments").set(newData, { merge: true });
                alert("Seção 'Tratamentos' atualizada com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar a seção Tratamentos:", error);
                alert("Ocorreu um erro. Tente novamente.");
            }
        });

        document.getElementById('add-gallery-image').addEventListener('click', async () => {
            const url = document.getElementById('gallery-image-url').value.trim();
            if (!url) { alert("Por favor, cole a URL da imagem."); return; }
            try {
                await db.collection("gallery").add({ url });
                alert("Imagem adicionada à galeria!");
                loadGallerySection();
                document.getElementById('gallery-image-url').value = '';
            } catch (error) { console.error("Erro ao adicionar imagem:", error); alert("Ocorreu um erro. Tente novamente."); }
        });

        document.getElementById('add-testimonial').addEventListener('click', async () => {
            const name = document.getElementById('testimonial-name').value;
            const text = document.getElementById('testimonial-text').value;
            if (!name || !text) { alert("Por favor, preencha o nome e o texto do depoimento."); return; }
            try {
                await db.collection("testimonials").add({ name, text });
                alert("Depoimento adicionado com sucesso!");
                loadTestimonialsSection();
                document.getElementById('testimonial-name').value = '';
                document.getElementById('testimonial-text').value = '';
            } catch (error) { console.error("Erro ao adicionar depoimento:", error); alert("Ocorreu um erro. Tente novamente."); }
        });

        // --- PRÉVIA EM TEMPO REAL PARA ÍCONES DE TRATAMENTO ---
        document.getElementById('harmonizacao-icon-url').addEventListener('input', (e) => {
            const preview = document.getElementById('harmonizacao-icon-preview');
            preview.src = e.target.value || 'https://placehold.co/80x80?text=Prévia';
        });

        document.getElementById('lentes-icon-url').addEventListener('input', (e) => {
            const preview = document.getElementById('lentes-icon-preview');
            preview.src = e.target.value || 'https://placehold.co/80x80?text=Prévia';
        });

        // --- FUNÇÕES DE EXCLUSÃO E AÇÕES DINÂMICAS ---
        document.addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('delete-gallery-item')) {
                if (!confirm("Tem certeza que deseja remover esta imagem da galeria?\n\n(A imagem original não será apagada do seu outro site).")) return;
                const docId = e.target.dataset.id;
                try { await db.collection("gallery").doc(docId).delete(); alert("Imagem removida da galeria!"); loadGallerySection(); } 
                catch (error) { console.error("Erro ao remover imagem:", error); alert("Ocorreu um erro ao remover a imagem."); }
            }
            if (e.target && e.target.classList.contains('delete-testimonial-item')) {
                 if (!confirm("Tem certeza que deseja excluir este depoimento?")) return;
                 const docId = e.target.dataset.id;
                 try { await db.collection("testimonials").doc(docId).delete(); alert("Depoimento excluído com sucesso!"); loadTestimonialsSection(); } 
                 catch (error) { console.error("Erro ao excluir o depoimento:", error); alert("Ocorreu um erro ao excluir o depoimento."); }
            }
            if (e.target && e.target.classList.contains('save-background-btn')) {
                const sectionId = e.target.dataset.sectionId;
                const imageUrl = document.getElementById(`bg-url-${sectionId}`).value.trim();
                try {
                    await db.collection("siteContent").doc("backgrounds").set({ [sectionId]: imageUrl }, { merge: true });
                    alert(`Fundo da seção "${sectionId}" atualizado com sucesso!`);
                } catch (error) { console.error("Erro ao salvar fundo:", error); alert("Ocorreu um erro ao salvar. Tente novamente."); }
            }
        });
    </script>
</body>
</html>
